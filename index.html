<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProAudio Cat√°logo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Importar fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind: bg-slate-50 */
            color: #1e293b; /* Tailwind: text-slate-800 */
        }
        /* Estilo para las tarjetas de producto */
        .product-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        /* Estilo para las im√°genes en la galer√≠a */
        .image-gallery img {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .image-gallery img:hover {
            transform: scale(1.05);
        }
        /* Alineaci√≥n de estrellas */
        .star-rating svg {
            display: inline-block;
            vertical-align: middle;
            margin-right: 2px;
        }
        /* Estilo para el bot√≥n de categor√≠a activo */
        .category-button.active {
            @apply bg-purple-600 text-white;
        }
        /* Contenedor de la cuadr√≠cula de productos para scroll horizontal en m√≥vil */
        .product-grid-container {
            overflow-x: auto;
            white-space: nowrap; /* Evita que los elementos se envuelvan */
            -webkit-overflow-scrolling: touch; /* Desplazamiento suave en iOS */
        }
        .product-grid-container::-webkit-scrollbar {
            height: 8px;
        }
        .product-grid-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Tailwind: bg-slate-300 */
            border-radius: 4px;
        }
        .product-grid-container::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* Tailwind: bg-slate-100 */
        }
        /* Para pantallas m√°s grandes, mostrar como una cuadr√≠cula */
        @media (min-width: 640px) { /* sm breakpoint */
            .product-grid-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.5rem; /* Tailwind: gap-6 */
                overflow-x: visible;
                white-space: normal;
            }
        }

        /* Estilos para el carrito flotante */
        .floating-cart-btn {
            position: fixed;
            bottom: 1.5rem; /* 24px */
            left: 1.5rem; /* 24px */
            z-index: 1000;
            @apply bg-purple-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center cursor-pointer;
            transition: transform 0.2s ease-in-out;
        }
        .floating-cart-btn:hover {
            transform: scale(1.05);
        }
        .cart-icon {
            width: 28px;
            height: 28px;
        }
        .cart-count {
            @apply absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center;
        }

        /* Estilos para el modal del carrito */
        .cart-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .cart-modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .cart-modal-content {
            @apply bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-3/4 lg:w-2/5 max-h-[90vh] overflow-y-auto;
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        .cart-modal-overlay.open .cart-modal-content {
            transform: translateY(0);
        }
        .cart-item {
            @apply flex items-center border-b border-slate-200 py-3;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-image {
            @apply w-16 h-16 object-contain rounded-md mr-4;
        }
        .quantity-control button {
            @apply bg-slate-200 text-slate-800 px-2 py-1 rounded-md hover:bg-slate-300;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Encabezado y Navegaci√≥n -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold text-purple-700 mb-2 md:mb-0">ProAudio Cat√°logo</h1>
            <nav class="flex flex-wrap justify-center md:justify-end gap-2 md:gap-4">
                <button class="category-button px-4 py-2 rounded-lg text-slate-700 hover:bg-purple-100 hover:text-purple-700 transition duration-200" data-category="all">Todos</button>
                <button class="category-button px-4 py-2 rounded-lg text-slate-700 hover:bg-purple-100 hover:text-purple-700 transition duration-200" data-category="Micr√≥fonos">üéô Micr√≥fonos</button>
                <button class="category-button px-4 py-2 rounded-lg text-slate-700 hover:bg-purple-100 hover:text-purple-700 transition duration-200" data-category="Aud√≠fonos">üéß Aud√≠fonos</button>
                <button class="category-button px-4 py-2 rounded-lg text-slate-700 hover:bg-purple-100 hover:text-purple-700 transition duration-200" data-category="Interfaces / Mixers">üéö Interfaces / Mixers</button>
                <button class="category-button px-4 py-2 rounded-lg text-slate-700 hover:bg-purple-100 hover:text-purple-700 transition duration-200" data-category="Accesorios">‚öôÔ∏è Accesorios</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-6 mt-4">
        <!-- Secci√≥n del Cat√°logo de Productos -->
        <section>
            <h2 class="text-2xl font-semibold mb-4 text-purple-700">Nuestro Cat√°logo</h2>
            <div id="productGrid" class="product-grid-container">
                <!-- Aqu√≠ se renderizar√°n los productos -->
            </div>
            <p id="noProductsMessage" class="hidden text-center text-slate-600 mt-8">No hay productos disponibles en esta categor√≠a.</p>
        </section>
    </main>

    <!-- Carrito Flotante -->
    <div id="floatingCartBtn" class="floating-cart-btn">
        <!-- Icono de Carrito (SVG de Phosphor Icons para buen estilo) -->
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-cart cart-icon" viewBox="0 0 16 16">
            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.485-.379L1.91 5H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
        </svg>
        <span id="cartItemCount" class="cart-count">0</span>
    </div>

    <!-- Modal del Carrito -->
    <div id="cartModalOverlay" class="cart-modal-overlay">
        <div class="cart-modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-purple-700">Mi Carrito (Lista de Deseos)</h2>
                <button id="closeCartModal" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="cartItemsList" class="max-h-60 overflow-y-auto mb-4">
                <!-- Los elementos del carrito se renderizar√°n aqu√≠ -->
                <p id="emptyCartMessage" class="text-slate-600 text-center py-4">Tu carrito est√° vac√≠o.</p>
            </div>
            <div class="border-t pt-4">
                <div class="flex justify-between text-lg font-medium mb-1">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">$0.00</span>
                </div>
                <div class="flex justify-between text-lg font-medium mb-2">
                    <span>Impuesto:</span>
                    <span id="cartTax">$0.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-purple-700">
                    <span>Total:</span>
                    <span id="cartTotal">$0.00</span>
                </div>
                <button id="clearCartBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition duration-200 mt-4 w-full">Vaciar Carrito</button>
            </div>
        </div>
    </div>


    <!-- Pie de P√°gina -->
    <footer class="bg-white shadow-inner p-6 mt-8 text-center text-slate-600">
        <p>&copy; 2024 ProAudio Cat√°logo. Todos los derechos reservados.</p>
        <p>Contacto: <a href="mailto:info@proaudio.com" class="text-purple-600 hover:underline">info@proaudio.com</a></p>
        <p class="mt-2 text-sm">
            <a href="manage_products.html" class="text-slate-500 hover:underline">Gestionar Productos</a>
        </p>
    </footer>

    <script>
        const PRODUCT_STORAGE_KEY = 'proaudio_catalog_products';
        const CART_STORAGE_KEY = 'proaudio_cart';
        const CART_EXPIRATION_DAYS = 14; // Carrito se borra despu√©s de 14 d√≠as
        const TAX_RATE = 0.09; // 9% de impuesto

        let currentProducts = []; // Almacenar√° los productos actualmente mostrados (ejemplo o cargados por JSON)
        let cartItems = []; // Almacenar√° los productos en el carrito

        // Productos de ejemplo (solo se usan si no hay productos guardados en localStorage)
        const sampleProducts = [
            {
                id: 'prod001',
                name: "Rode Wireless GO II",
                description: "Sistema de micr√≥fono inal√°mbrico ultracompacto de doble canal ideal para entrevistas y vlogs.",
                originalPrice: 299.00,
                rating: 4.8,
                reviewsCount: 3500,
                category: "Micr√≥fonos",
                images: [
                    "https://m.media-amazon.com/images/I/61Nl-t0+JmL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/611aE1h4NqL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71hLg9n3uGL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/719F8D06gEL._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod002',
                name: "HyperX QuadCast S - Micr√≥fono Condensador RGB",
                description: "Micr√≥fono USB para juegos y streaming con impresionantes efectos de iluminaci√≥n RGB din√°micos y cuatro patrones polares.",
                originalPrice: 159.99,
                rating: 4.7,
                reviewsCount: 8900,
                category: "Micr√≥fonos",
                images: [
                    "https://m.media-amazon.com/images/I/71r9fU5kI7L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/7123+Y4a-ML._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/714h8y1J-YL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/711qjS0JcUL._AC_SL1500_.jpg",
                ]
            },
            {
                id: 'prod003',
                name: "Rode VXLR Adaptador Hembra a TRS Macho",
                description: "Adaptador compacto para convertir un conector XLR hembra en un jack TRS de 3.5mm.",
                originalPrice: 15.00,
                rating: 4.6,
                reviewsCount: 250,
                category: "Accesorios",
                images: [
                    "https://m.media-amazon.com/images/I/617D9t9u61L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/61-dJ34G8xL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/61J64M5T3rL._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod004',
                name: "Focusrite Scarlett 2i2 3rd Gen",
                description: "Interfaz de audio USB de 2 entradas/2 salidas, ideal para m√∫sicos y podcasters con preamplificadores de micr√≥fono mejorados.",
                originalPrice: 179.99,
                rating: 4.7,
                reviewsCount: 15000,
                category: "Interfaces / Mixers",
                images: [
                    "https://m.media-amazon.com/images/I/61M-WcT05XL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/61z95W5m1CL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71N1+0+e7XL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/618xQ2rXWnL._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod005',
                name: "Sony MDR7506 Auriculares Profesionales",
                description: "Auriculares de estudio cerrados, legendarios por su sonido preciso y aislamiento, ideales para monitoreo de audio.",
                originalPrice: 99.99,
                rating: 4.8,
                reviewsCount: 45000,
                category: "Aud√≠fonos",
                images: [
                    "https://m.media-amazon.com/images/I/71z7j1w+HCL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/81x9C3b6n4L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/81u2H0Jq-SL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71+R+z+k+3L._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod006',
                name: "TONOR Adjustable Microphone Arm",
                description: "Brazo de micr√≥fono ajustable con soporte de abrazadera de escritorio y gesti√≥n de cables integrada.",
                originalPrice: 35.00,
                rating: 4.5,
                reviewsCount: 800,
                category: "Accesorios",
                images: [
                    "https://m.media-amazon.com/images/I/71E3rTjM44L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71e-S1A2NBL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71q+Rj-xLlL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71iB5z5c3yL._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod007',
                name: "Behringer UMC202HD Interfaz de Audio",
                description: "Interfaz de audio USB de 2 entradas/2 salidas con preamplificadores MIDAS de alta calidad para grabaci√≥n.",
                originalPrice: 129.00,
                rating: 4.6,
                reviewsCount: 10000,
                category: "Interfaces / Mixers",
                images: [
                    "https://m.media-amazon.com/images/I/71-Lg8f7HRL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/617n-J2V4JL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/61kG+4+sB1L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/7123+A-vL2L._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod008',
                name: "HyperX Cloud II - Auriculares Gaming",
                description: "Auriculares para juegos con sonido envolvente virtual 7.1, micr√≥fono con cancelaci√≥n de ruido y comodidad premium.",
                originalPrice: 79.99,
                rating: 4.6,
                reviewsCount: 50000,
                category: "Aud√≠fonos",
                images: [
                    "https://m.media-amazon.com/images/I/71W-u2sLhML._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71N-2l-YyEL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71+0M2Q-wRL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71z9X-g-LXL._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod009',
                name: "Blue Yeti USB Micr√≥fono",
                description: "Micr√≥fono USB vers√°til con m√∫ltiples patrones polares, ideal para podcasting, streaming y grabaciones de m√∫sica.",
                originalPrice: 129.99,
                rating: 4.7,
                reviewsCount: 75000,
                category: "Micr√≥fonos",
                images: [
                    "https://m.media-amazon.com/images/I/71Lg1FzJv9L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71h3zJ7fVBL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/717v2fV911L._AC_SL1500_.jpg"
                ]
            },
            {
                id: 'prod010',
                name: "TONOR TC-777 Micr√≥fono de Condensador USB",
                description: "Micr√≥fono de condensador USB plug & play, ideal para grabar voces y podcasts.",
                originalPrice: 39.99,
                rating: 4.4,
                reviewsCount: 1500,
                category: "Micr√≥fonos",
                images: [
                    "https://m.media-amazon.com/images/I/71Yf9+f-pLL._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71nO4M0uC1L._AC_SL1500_.jpg",
                    "https://m.media-amazon.com/images/I/71Q3d1F-7BL._AC_SL1500_.jpg"
                ]
            }
        ];

        // Funci√≥n para calcular el precio seg√∫n las reglas definidas
        function calculatePrice(originalPrice) {
            let finalPrice;
            if (originalPrice <= 50) {
                finalPrice = originalPrice * 2.5;
            } else if (originalPrice <= 100) {
                finalPrice = originalPrice * 2;
            } else {
                finalPrice = originalPrice * 1.4;
            }
            return parseFloat(finalPrice.toFixed(2)); // Retornar como n√∫mero flotante
        }

        // Funci√≥n para calcular la cantidad de rese√±as multiplicando por 100
        function calculateReviews(originalReviewsCount) {
            return originalReviewsCount * 100;
        }

        // Funci√≥n para generar el HTML de las estrellas de rese√±a
        function getStarRatingHTML(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (rating >= i) {
                    starsHtml += `<svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279L12 18.896l-7.416 3.816 1.48-8.279L.001 9.306l8.332-1.151L12 .587z"/></svg>`;
                } else {
                    starsHtml += `<svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 24 24"><path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279L12 18.896l-7.416 3.816 1.48-8.279L.001 9.306l8.332-1.151L12 .587z"/></svg>`;
                }
            }
            return starsHtml;
        }

        // Funci√≥n para generar una descripci√≥n mejorada usando la API de Gemini
        async function generateEnhancedDescription(productId, productName, currentDescription, buttonElement) {
            buttonElement.disabled = true;
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'Generando...';
            buttonElement.classList.add('opacity-50', 'cursor-not-allowed');

            const prompt = `Genera una descripci√≥n concisa (no m√°s de 80 palabras) y atractiva para un producto llamado '${productName}' que actualmente se describe como '${currentDescription}'. Enf√≥cate en sus caracter√≠sticas principales y beneficios para el usuario, usando un tono profesional y persuasivo.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const MAX_RETRIES = 3;
            const BASE_DELAY_MS = 1000;

            while (retries < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            const delay = BASE_DELAY_MS * Math.pow(2, retries) + Math.random() * 100;
                            console.warn(`Demasiadas solicitudes. Reintentando en ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            retries++;
                            continue;
                        }
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const newDescription = result.candidates[0].content.parts[0].text;

                        const productCardElement = document.getElementById(`product-${productId}`);
                        if (productCardElement) {
                            const descriptionElement = productCardElement.querySelector('.product-description');
                            if (descriptionElement) {
                                descriptionElement.textContent = newDescription;
                                const productIndex = currentProducts.findIndex(p => p.id === productId);
                                if (productIndex !== -1) {
                                    currentProducts[productIndex].description = newDescription;
                                }
                            }
                        }
                        break;
                    } else {
                        throw new Error('Respuesta de la API inesperada o contenido vac√≠o.');
                    }
                } catch (error) {
                    console.error('Error al generar descripci√≥n con Gemini API:', error);
                    if (retries === MAX_RETRIES - 1) {
                        showNotification(`No se pudo generar la descripci√≥n mejorada para ${productName}. Int√©ntalo de nuevo m√°s tarde.`, 'error');
                    }
                    retries++;
                    const delay = BASE_DELAY_MS * Math.pow(2, retries) + Math.random() * 100;
                    await new Promise(res => setTimeout(res, delay));
                }
            }

            buttonElement.disabled = false;
            buttonElement.textContent = originalText;
            buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // Funci√≥n principal para renderizar un solo producto en una tarjeta
        function renderProduct(product) {
            const finalPrice = calculatePrice(product.originalPrice);
            const totalReviews = calculateReviews(product.reviewsCount);

            const productCard = document.createElement('div');
            productCard.className = 'product-card bg-white rounded-lg overflow-hidden shadow-lg p-4 flex flex-col items-center text-center relative';
            productCard.id = `product-${product.id}`;
            productCard.setAttribute('data-category', product.category);

            const imageGallery = document.createElement('div');
            imageGallery.className = 'image-gallery w-full h-48 md:h-64 overflow-hidden rounded-md mb-4 relative';
            imageGallery.dataset.currentImageIndex = 0;

            const mainImage = document.createElement('img');
            mainImage.src = product.images[0];
            mainImage.alt = product.name;
            mainImage.className = 'w-full h-full object-contain transition-all duration-300 transform hover:scale-105';
            mainImage.onerror = function() { this.src = 'https://placehold.co/600x400/cccccc/333333?text=Imagen+No+Disponible'; };
            imageGallery.appendChild(mainImage);

            if (product.images.length > 1) {
                const imageNav = document.createElement('div');
                imageNav.className = 'absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 bg-black bg-opacity-50 p-1 rounded-full';
                product.images.forEach((imgSrc, index) => {
                    const dot = document.createElement('span');
                    dot.className = `w-2 h-2 rounded-full cursor-pointer transition-colors duration-200 ${index === 0 ? 'bg-white' : 'bg-gray-400'}`;
                    dot.onclick = (e) => {
                        e.stopPropagation();
                        mainImage.src = imgSrc;
                        imageGallery.dataset.currentImageIndex = index;
                        Array.from(imageNav.children).forEach((d, i) => {
                            d.className = `w-2 h-2 rounded-full cursor-pointer transition-colors duration-200 ${i === index ? 'bg-white' : 'bg-gray-400'}`;
                        });
                    };
                    imageNav.appendChild(dot);
                });
                imageGallery.appendChild(imageNav);

                mainImage.onclick = () => {
                    let currentIndex = parseInt(imageGallery.dataset.currentImageIndex);
                    currentIndex = (currentIndex + 1) % product.images.length;
                    mainImage.src = product.images[currentIndex];
                    imageGallery.dataset.currentImageIndex = currentIndex;
                    Array.from(imageNav.children).forEach((d, i) => {
                        d.className = `w-2 h-2 rounded-full cursor-pointer transition-colors duration-200 ${i === currentIndex ? 'bg-white' : 'bg-gray-400'}`;
                    });
                };
            }

            const name = document.createElement('h3');
            name.className = 'text-xl font-semibold text-slate-900 mb-2';
            name.textContent = product.name;

            const description = document.createElement('p');
            description.className = 'product-description text-sm text-slate-600 mb-3 flex-grow';
            description.textContent = product.description;

            const generateDescriptionButton = document.createElement('button');
            generateDescriptionButton.className = 'bg-purple-500 text-white px-3 py-1 text-sm rounded-lg hover:bg-purple-600 transition duration-200 mt-2 mb-3';
            generateDescriptionButton.textContent = 'Generar Descripci√≥n ‚ú®';
            generateDescriptionButton.onclick = () => generateEnhancedDescription(product.id, product.name, product.description, generateDescriptionButton);

            const price = document.createElement('p');
            price.className = 'text-2xl font-bold text-purple-700 mb-2';
            price.textContent = `$${finalPrice.toFixed(2)}`; // Formatear precio para mostrar

            const reviewSection = document.createElement('div');
            reviewSection.className = 'flex items-center justify-center mb-3 star-rating';
            reviewSection.innerHTML = getStarRatingHTML(product.rating);
            const reviewCountText = document.createElement('span');
            reviewCountText.className = 'text-sm text-slate-500 ml-2';
            reviewCountText.textContent = `${totalReviews.toLocaleString('es-ES')} rese√±as`;
            reviewSection.appendChild(reviewCountText);

            // Bot√≥n "A√±adir al Carrito"
            const addToCartButton = document.createElement('button');
            addToCartButton.className = 'bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 mt-3 w-full';
            addToCartButton.textContent = 'A√±adir al Carrito';
            addToCartButton.onclick = () => addToCart(product);

            productCard.appendChild(imageGallery);
            productCard.appendChild(name);
            productCard.appendChild(description);
            productCard.appendChild(generateDescriptionButton);
            productCard.appendChild(price);
            productCard.appendChild(reviewSection);
            productCard.appendChild(addToCartButton); // A√±adir el bot√≥n del carrito

            return productCard;
        }

        // Funci√≥n para renderizar todos los productos en la cuadr√≠cula, aplicando filtros de categor√≠a
        function renderProducts(productsToRender) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';
            const noProductsMessage = document.getElementById('noProductsMessage');

            if (productsToRender.length === 0) {
                noProductsMessage.classList.remove('hidden');
            } else {
                noProductsMessage.classList.add('hidden');
                productsToRender.forEach(product => {
                    productGrid.appendChild(renderProduct(product));
                });
            }
        }

        // Manejador de eventos para los botones de categor√≠a
        function handleCategoryClick(event) {
            const category = event.target.dataset.category;
            const buttons = document.querySelectorAll('.category-button');
            buttons.forEach(button => button.classList.remove('active'));
            event.target.classList.add('active');

            let filteredProducts = [];
            if (category === 'all') {
                filteredProducts = currentProducts;
            } else {
                filteredProducts = currentProducts.filter(product => product.category === category);
            }
            renderProducts(filteredProducts);
        }

        // --- L√≥gica del Carrito ---

        // Guarda el carrito en localStorage con una fecha de expiraci√≥n
        function saveCart() {
            const expirationTime = new Date().getTime() + (CART_EXPIRATION_DAYS * 24 * 60 * 60 * 1000); // 2 semanas en milisegundos
            const dataToStore = {
                items: cartItems,
                expiresAt: expirationTime
            };
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(dataToStore));
            updateCartUI(); // Actualiza la UI despu√©s de guardar
        }

        // Carga el carrito de localStorage y verifica la expiraci√≥n
        function loadCart() {
            const storedData = localStorage.getItem(CART_STORAGE_KEY);
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    const now = new Date().getTime();
                    if (data.expiresAt && now < data.expiresAt) {
                        cartItems = data.items;
                    } else {
                        // Carrito expirado, lo vaciamos
                        cartItems = [];
                        localStorage.removeItem(CART_STORAGE_KEY);
                        showNotification('Tu carrito ha sido vaciado por inactividad (m√°s de 2 semanas).', 'info');
                    }
                } catch (e) {
                    console.error("Error al parsear el carrito de localStorage:", e);
                    cartItems = []; // Si hay un error, vaciar el carrito para evitar problemas
                    localStorage.removeItem(CART_STORAGE_KEY);
                }
            } else {
                cartItems = [];
            }
            updateCartUI(); // Actualiza la UI despu√©s de cargar
        }

        // A√±ade un producto al carrito
        function addToCart(product) {
            // Aseg√∫rate de usar el precio calculado para el carrito
            const itemPrice = calculatePrice(product.originalPrice);

            const existingItem = cartItems.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cartItems.push({
                    id: product.id,
                    name: product.name,
                    price: itemPrice, // Usar el precio ya calculado
                    image: product.images[0],
                    quantity: 1,
                    addedAt: new Date().getTime() // Fecha de adici√≥n para expiraci√≥n
                });
            }
            saveCart();
            showNotification(`${product.name} a√±adido al carrito.`, 'success');
        }

        // Actualiza la cantidad de un art√≠culo en el carrito
        function updateCartItemQuantity(productId, newQuantity) {
            const itemIndex = cartItems.findIndex(item => item.id === productId);
            if (itemIndex !== -1) {
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else {
                    cartItems[itemIndex].quantity = newQuantity;
                    cartItems[itemIndex].addedAt = new Date().getTime(); // Refrescar timestamp al actualizar
                    saveCart();
                }
            }
        }

        // Elimina un producto del carrito
        function removeFromCart(productId) {
            cartItems = cartItems.filter(item => item.id !== productId);
            saveCart();
            showNotification('Producto eliminado del carrito.', 'info');
        }

        // Vac√≠a todo el carrito
        function clearCart() {
            cartItems = [];
            saveCart();
            showNotification('Carrito vaciado.', 'info');
        }

        // Actualiza la interfaz de usuario del carrito
        function updateCartUI() {
            const cartItemCount = document.getElementById('cartItemCount');
            const cartItemsList = document.getElementById('cartItemsList');
            const emptyCartMessage = document.getElementById('emptyCartMessage');
            const cartSubtotalElem = document.getElementById('cartSubtotal');
            const cartTaxElem = document.getElementById('cartTax');
            const cartTotalElem = document.getElementById('cartTotal');

            // Actualizar el contador del carrito flotante
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCount.textContent = totalItems;

            // Renderizar la lista de elementos en el modal
            cartItemsList.innerHTML = ''; // Limpiar lista
            let subtotal = 0;

            if (cartItems.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cartItems.forEach(item => {
                    subtotal += item.price * item.quantity;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-800">${item.name}</p>
                            <p class="text-sm text-purple-600">$${item.price.toFixed(2)} c/u</p>
                        </div>
                        <div class="flex items-center gap-2 quantity-control">
                            <button onclick="updateCartItemQuantity('${item.id}', ${item.quantity - 1})">-</button>
                            <span class="font-medium">${item.quantity}</span>
                            <button onclick="updateCartItemQuantity('${item.id}', ${item.quantity + 1})">+</button>
                            <button onclick="removeFromCart('${item.id}')" class="ml-2 text-red-500 hover:text-red-700 text-lg">üóë</button>
                        </div>
                    `;
                    cartItemsList.appendChild(itemDiv);
                });
            }

            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;

            cartSubtotalElem.textContent = `$${subtotal.toFixed(2)}`;
            cartTaxElem.textContent = `$${tax.toFixed(2)}`;
            cartTotalElem.textContent = `$${total.toFixed(2)}`;
        }


        // Funci√≥n para mostrar notificaciones temporales
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-transform transform translate-y-full opacity-0 duration-300`;
            if (type === 'success') {
                notification.classList.add('bg-green-500');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500');
            } else {
                notification.classList.add('bg-gray-700');
            }
            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-full', 'opacity-0');
                notification.classList.add('translate-y-0', 'opacity-100');
            }, 100);

            // Animate out and remove
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-full', 'opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        // Inicializaci√≥n de la p√°gina cuando el DOM est√° completamente cargado
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar productos del localStorage o usar ejemplos
            const storedProducts = localStorage.getItem(PRODUCT_STORAGE_KEY);
            if (storedProducts) {
                try {
                    currentProducts = JSON.parse(storedProducts);
                } catch (e) {
                    console.error("Error al cargar productos de localStorage, usando productos de ejemplo.", e);
                    currentProducts = sampleProducts;
                }
            } else {
                currentProducts = sampleProducts;
            }
            renderProducts(currentProducts);

            // Activar el bot√≥n 'Todos' por defecto al cargar la p√°gina
            document.querySelector('.category-button[data-category="all"]').classList.add('active');

            // Asignar manejadores de eventos a los botones de categor√≠a
            const categoryButtons = document.querySelectorAll('.category-button');
            categoryButtons.forEach(button => {
                button.addEventListener('click', handleCategoryClick);
            });

            // --- Inicializaci√≥n y Eventos del Carrito ---
            const floatingCartBtn = document.getElementById('floatingCartBtn');
            const cartModalOverlay = document.getElementById('cartModalOverlay');
            const closeCartModalBtn = document.getElementById('closeCartModal');
            const clearCartBtn = document.getElementById('clearCartBtn');

            floatingCartBtn.addEventListener('click', () => {
                cartModalOverlay.classList.add('open');
                updateCartUI(); // Asegurarse de que el carrito est√© actualizado al abrir
            });
            closeCartModalBtn.addEventListener('click', () => {
                cartModalOverlay.classList.remove('open');
            });
            cartModalOverlay.addEventListener('click', (e) => {
                if (e.target === cartModalOverlay) { // Cierra si se hace clic fuera del contenido
                    cartModalOverlay.classList.remove('open');
                }
            });
            clearCartBtn.addEventListener('click', clearCart);

            loadCart(); // Cargar el carrito al iniciar la p√°gina
        });
    </script>
</body>
</html>
